<?php
// Call RestoreTest::main() if this source file is executed directly.
if (!defined("PHPUnit_MAIN_METHOD")) {
    define("PHPUnit_MAIN_METHOD", "RestoreTest::main");
}

require_once "PHPUnit/Framework/TestCase.php";
require_once "PHPUnit/Framework/TestSuite.php";

require_once "testConf.php";

define('ROOT_PATH', $rootPath);
define('WPATH', $webPath);
$_SESSION['WPATH'] = WPATH;

require_once "Restore.php";
require_once "Backup.php";
require_once ROOT_PATH."/lib/confs/Conf.php";

/**
 * Test class for Restore.
 * Generated by PHPUnit_Util_Skeleton on 2006-10-12 at 08:36:24.
 */
class RestoreTest extends PHPUnit_Framework_TestCase {
    /**
     * Runs the test methods of this class.
     *
     * @access public
     * @static
     */
    
    public $classRestore = null;
    public $connection = null;
    
    public static function main() {
        require_once "PHPUnit/TextUI/TestRunner.php";

        $suite  = new PHPUnit_Framework_TestSuite("RestoreTest");
        $result = PHPUnit_TextUI_TestRunner::run($suite);
    }

    /**
     * Sets up the fixture, for example, open a network connection.
     * This method is called before a test is executed.
     *
     * @access protected
     */
    protected function setUp() {
    	$this->classRestore = new Restore(); 
    	
    	$conf = new Conf();
    	$this->connection = mysql_connect($conf->dbhost.":".$conf->dbport, $conf->dbuser, $conf->dbpass);
    	mysql_query("Create Database BackupTest;");
    	mysql_select_db("BackupTest");
    	mysql_query("CREATE TABLE `data_sheet_info` (`request_id` int(10) NOT NULL auto_increment,
  `datasheet_type` varchar(200) NOT NULL default '',   `fullname` varchar(255) NOT NULL default '',
  `companyname` varchar(255) NOT NULL default '',   `jobtitle` varchar(100) NOT NULL default '',
  `noofemployees` varchar(100) NOT NULL default '',   `industry` varchar(100) NOT NULL default '',
  `companyaddress` text NOT NULL, `country` varchar(200) NOT NULL default '',
  `phone` varchar(25) NOT NULL default '',   `email` varchar(100) NOT NULL default '',
  `addtioanlcomments` text NOT NULL,   `foundusfrom` varchar(100) NOT NULL default '',
  `date` varchar(12) NOT NULL default '',   PRIMARY KEY  (`request_id`))");
       
        mysql_query("INSERT INTO `data_sheet_info` VALUES (1,'nnn','nn','nn','nn','nn','nn','nn','nn','nn','nn','nn','nn',''),(2,'wireless-i banco','ss','ss','ss','50-99','Automotive','ssssssssss','American Samoa','ss','ss@ss.com','ssss','Yahoo!',''),(3,'wireless-i banco','Testing','Testing','Testing','50-99','Aerospace','Testing Testing Testing \r\nTesting ','Afghanistan','Testing','Testing@beyondm.com','Testing Testing Testing ','Email',''),(4,'wireless-i banco','sureshkumar','manhar','s.d','l-49','Computer/Technology-Manufacturer','pavani prestage','India','9849834559','ask_b4u@sify.com','','Other','')");
        
		mysql_query("Create Database BackupTest1;");
		mysql_select_db("BackupTest1");
   }

    /**
     * Tears down the fixture, for example, close a network connection.
     * This method is called after a test is executed.
     *
     * @access protected
     */
    protected function tearDown() {
    	mysql_query("Drop Database BackupTest;");
    	mysql_query("Drop Database BackupTest1;");
    	   	
   }

   public function testFillDatabase() {
   
   	$con = mysql_connect("localhost", "root", "beyondm");
   	$file = $this->_getbackup();
   	
	$this->assertEquals($file, true, "No record found");

   	
   	$this->classRestore->setConnection($con);
   	$this->classRestore->setDatabase("BackupTest1");
   	$this->classRestore->setFileSource($file);
   	$this->classRestore->fillDatabase();
   	
   	$db = @mysql_select_db("BackupTest1");

		if (!empty($db)) {

			// Get all table names from database
			$c = 0;
			$result = mysql_list_tables("BackupTest1");
			for($x = 0; $x < mysql_num_rows($result); $x++) {
				$table = mysql_tablename($result, $x);
				if (!empty($table)) {
					$arr_tables[$c] = mysql_tablename($result, $x);
					$c++;
				}
			}
		}
		else {	
			$this->assertEquals( $db, null, "No record found");
		}
   		$this->assertEquals( count($arr_tables), 1, "No record found");
   }
   
   public function _getbackup(){
   		
   	$con = mysql_connect("localhost", "root", "beyondm");
   	$backup = new Backup();
   	$backup->setConnection($con);
   	$backup->setDatabase("BackupTest");
   	$filesource = $backup->dumpDatabase(true);
   	return $filesource;
   }
}

// Call RestoreTest::main() if this source file is executed directly.
if (PHPUnit_MAIN_METHOD == "RestoreTest::main") {
    RestoreTest::main();
}
?>
